# === Tmux 配置文件 ===
# 适配 macOS、Arch、Debian 的通用配置

# ============================================
# 基础设置
# ============================================

# 修改前缀键为 Ctrl-a (更符合人体工程学)
set -g prefix C-a
unbind C-b
bind C-a send-prefix

# 启用鼠标支持
set -g mouse on

# 起始编号从 1 开始 (0 在键盘太远)
set -g base-index 1
setw -g pane-base-index 1

# 终端颜色支持
set -g default-terminal "tmux-256color"
set -ag terminal-overrides ",xterm-256color:RGB"
set -ag terminal-overrides ",alacritty:RGB"
set -ag terminal-overrides ",kitty:RGB"

# 历史记录
set -g history-limit 10000

# 减少 Escape 键延迟 (对 Vim 很重要)
set -sg escape-time 0

# 自动重新编号窗口
set -g renumber-windows on

# 活动监控
setw -g monitor-activity on
set -g visual-activity off

# ============================================
# 窗格操作
# ============================================

# 分割窗格快捷键 (更直观的符号)
bind | split-window -h -c "#{pane_current_path}"
bind - split-window -v -c "#{pane_current_path}"
unbind '"'
unbind %

# Vim 风格的窗格切换
bind h select-pane -L
bind j select-pane -D
bind k select-pane -U
bind l select-pane -R

# 调整窗格大小
bind -r H resize-pane -L 5
bind -r J resize-pane -D 5
bind -r K resize-pane -U 5
bind -r L resize-pane -R 5

# 快速切换窗格布局
bind Space next-layout

# 最大化/还原窗格
bind m resize-pane -Z

# ============================================
# 窗口操作
# ============================================

# 创建新窗口在当前路径
bind c new-window -c "#{pane_current_path}"

# 快速切换窗口
bind -r C-h select-window -t :-
bind -r C-l select-window -t :+

# Alt + 数字快速切换窗口 (macOS 需要在终端设置中启用 Option 作为 Meta)
bind -n M-1 select-window -t 1
bind -n M-2 select-window -t 2
bind -n M-3 select-window -t 3
bind -n M-4 select-window -t 4
bind -n M-5 select-window -t 5

# ============================================
# 复制模式 (Vim 风格)
# ============================================

# 进入复制模式
bind [ copy-mode
bind ] paste-buffer

# Vim 风格的复制模式快捷键
setw -g mode-keys vi
bind -T copy-mode-vi v send -X begin-selection
bind -T copy-mode-vi y send -X copy-selection-and-cancel
bind -T copy-mode-vi r send -X rectangle-toggle

# 系统剪贴板集成 (跨平台)
# macOS
if-shell "uname | grep -q Darwin" \
  "bind -T copy-mode-vi y send -X copy-pipe-and-cancel 'pbcopy'; \
   bind -T copy-mode-vi MouseDragEnd1Pane send -X copy-pipe-and-cancel 'pbcopy'"

# Linux (X11)
if-shell "uname | grep -q Linux && command -v xclip" \
  "bind -T copy-mode-vi y send -X copy-pipe-and-cancel 'xclip -in -selection clipboard'; \
   bind -T copy-mode-vi MouseDragEnd1Pane send -X copy-pipe-and-cancel 'xclip -in -selection clipboard'"

# Linux (Wayland)
if-shell "uname | grep -q Linux && command -v wl-copy" \
  "bind -T copy-mode-vi y send -X copy-pipe-and-cancel 'wl-copy'; \
   bind -T copy-mode-vi MouseDragEnd1Pane send -X copy-pipe-and-cancel 'wl-copy'"

# ============================================
# 实用快捷键
# ============================================

# 重新加载配置文件
bind r source-file ~/.tmux.conf \; display "配置已重载！"

# 快速打开配置文件
bind e new-window -n "tmux.conf" "nvim ~/.tmux.conf"

# 清屏
bind C-l send-keys 'C-l'

# 杀死当前会话并切换到下一个
bind X confirm-before -p "杀死会话 #S? (y/n)" "run-shell 'tmux switch-client -n \\\; kill-session -t \"#S\"'"

# ============================================
# 状态栏配置
# ============================================

# 启用状态栏
set -g status on
set -g status-position bottom
set -g status-justify left
set -g status-interval 5

# 状态栏颜色
set -g status-style fg=white,bg=colour234
set -g window-status-style fg=colour245,bg=default
set -g window-status-current-style fg=colour117,bg=default,bold
set -g pane-border-style fg=colour238
set -g pane-active-border-style fg=colour117

# 状态栏格式
set -g status-left-length 40
set -g status-right-length 80

# 左侧: 会话名
set -g status-left "#[fg=colour232,bg=colour154,bold] #S #[fg=colour154,bg=colour234]"

# 右侧: 系统信息
set -g status-right "#[fg=colour238]#[fg=colour245,bg=colour238] %Y-%m-%d #[fg=colour254]%H:%M #[fg=colour117]#[fg=colour232,bg=colour117,bold] #h "

# 窗口列表格式
set -g window-status-format " #I:#W#F "
set -g window-status-current-format " #I:#W#F "
set -g window-status-separator ""

# 消息样式
set -g message-style fg=colour232,bg=colour154,bold

# ============================================
# 插件管理 (TPM - Tmux Plugin Manager)
# ============================================

# 插件列表
set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'tmux-plugins/tmux-sensible'
set -g @plugin 'tmux-plugins/tmux-resurrect'
set -g @plugin 'tmux-plugins/tmux-continuum'
set -g @plugin 'tmux-plugins/tmux-yank'
set -g @plugin 'christoomey/vim-tmux-navigator'

# tmux-resurrect 配置
set -g @resurrect-strategy-nvim 'session'
set -g @resurrect-capture-pane-contents 'on'

# tmux-continuum 配置 (自动保存/恢复)
set -g @continuum-restore 'on'
set -g @continuum-save-interval '15'

# vim-tmux-navigator 配置
set -g @plugin 'christoomey/vim-tmux-navigator'
is_vim="ps -o state= -o comm= -t '#{pane_tty}' \
    | grep -iqE '^[^TXZ ]+ +(\\S+\\/)?g?(view|n?vim?x?)(diff)?$'"
bind -n C-h if-shell "$is_vim" "send-keys C-h"  "select-pane -L"
bind -n C-j if-shell "$is_vim" "send-keys C-j"  "select-pane -D"
bind -n C-k if-shell "$is_vim" "send-keys C-k"  "select-pane -U"
bind -n C-l if-shell "$is_vim" "send-keys C-l"  "select-pane -R"

# ============================================
# TPM 自动安装
# ============================================

# 检查 TPM 是否安装
if "test ! -d ~/.tmux/plugins/tpm" \
   "run 'git clone https://github.com/tmux-plugins/tpm ~/.tmux/plugins/tpm && ~/.tmux/plugins/tpm/bin/install_plugins'"

# 初始化 TPM (保持在配置文件最底部)
run '~/.tmux/plugins/tpm/tpm'

# ============================================
# 平台特定配置
# ============================================

# macOS 特定设置
if-shell "uname | grep -q Darwin" \
  "set -g default-command 'reattach-to-user-namespace -l zsh'"
