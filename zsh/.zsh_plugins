# === Antidote 插件管理 ===
# 自动寻找 antidote
[[ -n "$ZSHRC_DEBUG" ]] && echo "[DEBUG] Searching for antidote..."
ANTIDOTE_INIT_LOADED=false

# 定义可能的 antidote 路径
ANTIDOTE_PATHS=(
  "${ZDOTDIR:-~}/.antidote/antidote.zsh"
  "/usr/share/zsh-antidote/antidote.zsh"
  "/opt/homebrew/opt/antidote/share/antidote/antidote.zsh"
  "/usr/local/opt/antidote/share/antidote/antidote.zsh"
  "$HOME/.local/share/antidote/antidote.zsh"
)

# 尝试加载 antidote
for antidote_path in "${ANTIDOTE_PATHS[@]}"; do
  if [ -f "$antidote_path" ]; then
    [[ -n "$ZSHRC_DEBUG" ]] && echo "[DEBUG] Found antidote at $antidote_path"
    source "$antidote_path"
    ANTIDOTE_INIT_LOADED=true
    break
  fi
done

# 检查 antidote 是否正确初始化
if [[ "$ANTIDOTE_INIT_LOADED" == true ]] && command -v antidote &>/dev/null; then
  [[ -n "$ZSHRC_DEBUG" ]] && echo "[DEBUG] Antidote initialized successfully"

  # 设置插件文件路径
  ANTIDOTE_PLUGINS="${ZDOTDIR:-$HOME}/.zsh_plugins.txt"
  ANTIDOTE_STATIC="${ZDOTDIR:-$HOME}/.zsh_plugins.zsh"

  # 检查插件文件是否存在
  if [[ -f "$ANTIDOTE_PLUGINS" ]]; then
    [[ -n "$ZSHRC_DEBUG" ]] && echo "[DEBUG] Loading plugins from $ANTIDOTE_PLUGINS"

    # 使用静态加载以提高性能
    # 如果静态文件不存在或插件列表更新了，则重新生成
    if [[ ! -f "$ANTIDOTE_STATIC" ]] || [[ "$ANTIDOTE_PLUGINS" -nt "$ANTIDOTE_STATIC" ]]; then
      [[ -n "$ZSHRC_DEBUG" ]] && echo "[DEBUG] Generating static plugin file..."
      antidote bundle <"$ANTIDOTE_PLUGINS" >"$ANTIDOTE_STATIC"
    fi

    # 加载静态插件文件
    [[ -n "$ZSHRC_DEBUG" ]] && echo "[DEBUG] Sourcing static plugins..."
    source "$ANTIDOTE_STATIC"
    [[ -n "$ZSHRC_DEBUG" ]] && echo "[DEBUG] Antidote plugins loaded successfully"
  else
    echo "⚠️  Warning: Plugin file not found: $ANTIDOTE_PLUGINS"
    echo "   Create it with your desired plugins."
  fi

  # ============================================
  # 插件配置
  # ============================================

  # ZSH Autosuggestions 配置
  ZSH_AUTOSUGGEST_HIGHLIGHT_STYLE="fg=#666666"
  ZSH_AUTOSUGGEST_STRATEGY=(history completion)
  ZSH_AUTOSUGGEST_BUFFER_MAX_SIZE=20

  # Command Time configuration
  ZSH_COMMAND_TIME_MIN_SECONDS=3
  ZSH_COMMAND_TIME_MSG="Execution time: %s"
  ZSH_COMMAND_TIME_COLOR="cyan"

  # History Substring Search 配置
  bindkey '^[[A' history-substring-search-up
  bindkey '^[[B' history-substring-search-down
  bindkey -M vicmd 'k' history-substring-search-up
  bindkey -M vicmd 'j' history-substring-search-down
else
  # Antidote 未正确初始化，显示警告
  echo "⚠️  Warning: Antidote not found or failed to initialize"
  echo "   Shell will continue without plugins."
  echo "   To install antidote, run one of:"
  echo "   - macOS: brew install antidote"
  echo "   - Linux: git clone --depth=1 https://github.com/mattmc3/antidote.git \${ZDOTDIR:-~}/.antidote"
fi
