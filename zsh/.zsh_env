# === Zsh 环境变量配置 ===
# 适配 macOS、Arch、Debian 的通用配置

# ============================================
# 平台检测
# ============================================

# 检测操作系统
if [[ "$(uname)" == "Darwin" ]]; then
    export OS_TYPE="macos"
    export OS_ARCH="$(uname -m)"
elif [[ -f /etc/os-release ]]; then
    . /etc/os-release
    export OS_TYPE="$ID"
else
    export OS_TYPE="$(uname -s | tr '[:upper:]' '[:lower:]')"
fi

# ============================================
# Homebrew 配置 (macOS)
# ============================================

if [[ "$OS_TYPE" == "macos" ]]; then
    # 根据架构选择 Homebrew 路径
    if [[ "$OS_ARCH" == "arm64" ]]; then
        export HOMEBREW_PREFIX="/opt/homebrew"
    else
        export HOMEBREW_PREFIX="/usr/local"
    fi

    # 初始化 Homebrew 环境
    if [[ -f "$HOMEBREW_PREFIX/bin/brew" ]]; then
        eval "$($HOMEBREW_PREFIX/bin/brew shellenv)"
    fi

    # Homebrew 配置
    export HOMEBREW_NO_ANALYTICS=1
    export HOMEBREW_NO_AUTO_UPDATE=1
fi

# ============================================
# Linux 特定配置
# ============================================

if [[ "$OS_TYPE" != "macos" ]] && [[ -o interactive ]]; then
    # Debian/Ubuntu: bat 命令别名
    if command -v batcat >/dev/null 2>&1 && ! command -v bat >/dev/null 2>&1; then
        alias bat='batcat'
    fi

    # fd-find 命令别名 (Debian/Ubuntu)
    if command -v fdfind >/dev/null 2>&1 && ! command -v fd >/dev/null 2>&1; then
        alias fd='fdfind'
    fi
fi

# ============================================
# 历史记录设置
# ============================================

export HISTSIZE=50000          # 内存中保存的历史行数
export SAVEHIST=50000          # 文件中保存的历史行数
export HISTFILE="$HOME/.zsh_history"

# 历史记录选项（仅在交互式 shell 中设置）
if [[ -o interactive ]]; then
  setopt HIST_IGNORE_ALL_DUPS    # 删除重复命令
  setopt HIST_FIND_NO_DUPS       # 搜索时不显示重复
  setopt HIST_REDUCE_BLANKS      # 删除多余空格
  setopt SHARE_HISTORY           # 实时跨窗口共享历史记录
  setopt INC_APPEND_HISTORY      # 立即写入历史文件
  setopt HIST_VERIFY             # 历史扩展时先显示，不立即执行
  setopt EXTENDED_HISTORY        # 保存时间戳和执行时长
fi

# ============================================
# 基础环境变量
# ============================================

export EDITOR='nvim'
export VISUAL='nvim'
export PAGER='less'

# Less 配置
export LESS='-R -M -i -j4'
export LESSHISTFILE='-'

# ============================================
# 路径管理
# ============================================

# 用户本地路径（优先级最高）
export PATH="$HOME/.local/bin:$HOME/bin:$PATH"

# Cargo (Rust)
if [[ -d "$HOME/.cargo/bin" ]]; then
    export PATH="$HOME/.cargo/bin:$PATH"
    export CARGO_HOME="$HOME/.cargo"
fi

# Go
if [[ -d "$HOME/go/bin" ]]; then
    export PATH="$HOME/go/bin:$PATH"
    export GOPATH="$HOME/go"
fi

# Node.js 全局包
if [[ -d "$HOME/.npm-global/bin" ]]; then
    export PATH="$HOME/.npm-global/bin:$PATH"
fi

# Python 用户级包
if command -v python3 >/dev/null 2>&1; then
    PYTHON_USER_BASE="$(python3 -m site --user-base 2>/dev/null)"
    if [[ -n "$PYTHON_USER_BASE" ]] && [[ -d "$PYTHON_USER_BASE/bin" ]]; then
        export PATH="$PYTHON_USER_BASE/bin:$PATH"
    fi
fi

# uv import
[[ -f "$HOME/.local/bin/env" ]] && . "$HOME/.local/bin/env"

# Deno
if [[ -d "$HOME/.deno/bin" ]]; then
    export PATH="$HOME/.deno/bin:$PATH"
    export DENO_INSTALL="$HOME/.deno"
fi

# Bun
if [[ -d "$HOME/.bun/bin" ]]; then
    export PATH="$HOME/.bun/bin:$PATH"
    export BUN_INSTALL="$HOME/.bun"
fi

# NVM (Node Version Manager)
export NVM_DIR="$HOME/.nvm"
if [[ -s "$NVM_DIR/nvm.sh" ]]; then
    # 延迟加载 NVM 以加快 shell 启动速度
    # 如果需要立即使用，可以取消注释下面这行
    # \. "$NVM_DIR/nvm.sh"

    # 使用懒加载提升启动速度
    alias nvm='unalias nvm && \. "$NVM_DIR/nvm.sh" && nvm'
    alias node='unalias node && unalias npm && \. "$NVM_DIR/nvm.sh" && node'
    alias npm='unalias npm && unalias node && \. "$NVM_DIR/nvm.sh" && npm'
fi

# 加载 NVM bash 补全（可选）
[[ -s "$NVM_DIR/bash_completion" ]] && \. "$NVM_DIR/bash_completion"

# ============================================
# FZF 配置
# ============================================

# FZF 默认命令（使用 ripgrep）
if command -v rg >/dev/null 2>&1; then
    export FZF_DEFAULT_COMMAND='rg --files --hidden --follow --glob "!.git/*"'
    export FZF_CTRL_T_COMMAND="$FZF_DEFAULT_COMMAND"
elif command -v fd >/dev/null 2>&1; then
    export FZF_DEFAULT_COMMAND='fd --type f --hidden --follow --exclude .git'
    export FZF_CTRL_T_COMMAND="$FZF_DEFAULT_COMMAND"
fi

# FZF 配色方案
export FZF_DEFAULT_OPTS="
    --height 40%
    --layout=reverse
    --border
    --inline-info
    --color=fg:#d0d0d0,bg:#121212,hl:#5f87af
    --color=fg+:#d0d0d0,bg+:#262626,hl+:#5fd7ff
    --color=info:#afaf87,prompt:#d7005f,pointer:#af5fff
    --color=marker:#87ff00,spinner:#af5fff,header:#87afaf
"

# ============================================
# 工具初始化
# ============================================

# Zoxide (智能 cd) - 仅在交互式 shell 中初始化
if [[ -o interactive ]] && command -v zoxide >/dev/null 2>&1; then
    eval "$(zoxide init zsh)" 2>/dev/null || true
fi

# Starship (备选提示符，如果不用 P10k)
# if command -v starship >/dev/null 2>&1; then
#     eval "$(starship init zsh)"
# fi

# ============================================
# 语言环境
# ============================================

export LANG=en_US.UTF-8
export LC_ALL=en_US.UTF-8
export LC_CTYPE=en_US.UTF-8

# ============================================
# 开发工具配置
# ============================================

# Docker
export DOCKER_BUILDKIT=1
export COMPOSE_DOCKER_CLI_BUILD=1

# GPG - 仅在有 tty 时设置
if tty -s 2>/dev/null; then
    export GPG_TTY=$(tty 2>/dev/null)
fi

# ============================================
# 性能优化
# ============================================

# 禁用 compinit 的安全检查（加快启动速度）
# 如果遇到权限问题，请注释掉这行
skip_global_compinit=1

# ============================================
# 颜色支持
# ============================================

# 启用颜色
export CLICOLOR=1

# LS_COLORS (GNU coreutils) - 仅在交互式 shell 中设置
if [[ -o interactive ]] && command -v dircolors >/dev/null 2>&1; then
    eval "$(dircolors -b)" 2>/dev/null || true
fi

# LSCOLORS (BSD/macOS)
export LSCOLORS=ExGxBxDxCxEgEdxbxgxcxd

# ============================================
# 终端配置
# ============================================

# Kitty 终端特定配置 - 仅在交互式 shell 中设置
if [[ -o interactive ]] && [[ "$TERM" == "xterm-kitty" ]]; then
    alias ssh='kitty +kitten ssh'
fi

# ============================================
# macOS 特定工具别名
# ============================================

if [[ "$OS_TYPE" == "macos" ]] && [[ -o interactive ]]; then
    # 使用 GNU 工具替代 BSD 工具
    if command -v gls >/dev/null 2>&1; then
        alias ls='gls --color=auto'
    fi
    if command -v gsed >/dev/null 2>&1; then
        alias sed='gsed'
    fi
    if command -v gtar >/dev/null 2>&1; then
        alias tar='gtar'
    fi
    if command -v gmake >/dev/null 2>&1; then
        alias make='gmake'
    fi
fi
